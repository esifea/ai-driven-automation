name: AI Agent

on:
  workflow_dispatch:
    inputs:
      task_id:
        description: 'Task ID'
      mode:
        description: 'Agent Mode'
        default: 'coder'
        type: choice
        options:
          - coder
          - reviewer
      pr_number:
        description: 'PR Number (for reviewer mode)'
        required: false
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, synchronize]
    branches: ["**"]
  pull_request_review:
    types: [submitted, edited]
  pull_request_review_comment:
    types: [created, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  coder-gemini:
    if: >-
      (github.event_name == 'workflow_dispatch' && inputs.mode == 'coder') ||
      (github.event_name == 'pull_request_review' && github.event.review.state == 'changes_requested') ||
      (contains(github.event.comment.body, '/ask') && (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment')) ||
      (contains(github.event.review.body, '/ask') && github.event_name == 'pull_request_review')
    runs-on: ubuntu-latest
    steps:
      - name: Generate App Token
        id: app-coder-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_CODER_ID }}
          private-key: ${{ secrets.APP_CODER_SECRET }}

      - name: Get PR Branch
        id: get-branch
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request
        env:
          GH_TOKEN: ${{ steps.app-coder-token.outputs.token }}
        run: |
          PR_NUMBER=${{ github.event.issue.number }}
          BRANCH=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json headRefName -q .headRefName)
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Checkout Repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.app-coder-token.outputs.token }}
          ref: ${{ steps.get-branch.outputs.branch || github.event.pull_request.head.ref || github.ref }}

      - name: Run AI Agent (Coder)
        id: coder_agent
        uses: ./
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          mode: coder
          task_id: ${{ inputs.task_id }}
          pr_question: >-
            ${{
              (contains(github.event.comment.body, '/ask') && github.event.comment.body) ||
              (contains(github.event.review.body, '/ask') && github.event.review.body) ||
              ''
            }}
          feedback: ${{ github.event.comment.body || github.event.review.body }}
          comment_path: ${{ github.event.comment.path }}
          comment_start_line: ${{ github.event.comment.start_line }}
          comment_end_line: ${{ github.event.comment.line }}

      - name: Clean & Push Changes
        id: push_changes
        env:
          GH_TOKEN: ${{ steps.app-coder-token.outputs.token }}
        run: |
          git config --global user.name "Gemini-Coder[bot]"
          git config --global user.email "${{ secrets.APP_CODER_ID }}+gemini-coder[bot]@users.noreply.github.com"
          
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

          if [ -f answer.md ]; then
            touch .gitignore
            if ! grep -Fxq "answer.md" .gitignore; then
              if [ -s .gitignore ] && [ -n "$(tail -c 1 .gitignore)" ]; then
                echo "" >> .gitignore
              fi
              echo "answer.md" >> .gitignore
            fi
          fi
          
          if [[ -z $(git status -s) ]]; then
            echo "No code changes implemented."
          else
            git add .
            git commit -m "refactor: AI implementation (Task ${{ inputs.task_id }})"
            
            if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.mode }}" == "coder" ]]; then
              BRANCH_NAME="refactor/task-${{ inputs.task_id }}-$(date +%s)"
              git checkout -b "$BRANCH_NAME"
              git push origin "$BRANCH_NAME"
              gh pr create --title "Task ${{ inputs.task_id }}" --body "AI Implementation" --base main --head "$BRANCH_NAME"
            else
              TARGET_BRANCH=${{ steps.get-branch.outputs.branch || github.event.pull_request.head.ref }}
              git push origin HEAD:$TARGET_BRANCH
              
              if [ ! -f answer.md ]; then
                echo "Triggering Reviewer for branch $TARGET_BRANCH..."
                gh workflow run agent-gemini.yml \
                  --ref "$TARGET_BRANCH" \
                  -f mode=reviewer \
                  -f pr_number=${{ github.event.issue.number || github.event.pull_request.number }} || true
              else
                echo "Skipping Reviewer trigger (Q&A mode detected)."
              fi
            fi
          fi

      - name: Post Reply
        if: hashFiles('answer.md') != '' && (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment')
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-coder-token.outputs.token }}
          script: |
            const fs = require('fs');
            try {
              if (fs.existsSync('answer.md')) {
                const response = fs.readFileSync('answer.md', 'utf8');

                if (context.eventName === 'pull_request_review_comment') {
                  await github.rest.pulls.createReplyForReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: context.payload.pull_request.number,
                    comment_id: context.payload.comment.id,
                    body: response
                  });
                  console.log("Replied to review comment");
                } else {
                  await github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: response
                  });
                  console.log("Replied to comment");
                }
              }
            } catch (e) {
              console.log("Error posting comment: " + e);
              core.setFailed(e.message);
            }

  reviewer-gemini:
    if: >-
      (github.event_name == 'workflow_dispatch' && inputs.mode == 'reviewer') ||
      (github.event_name == 'pull_request' && github.event.action != 'closed')
    runs-on: ubuntu-latest
    steps:
      - name: Generate App Token
        id: app-reviewer-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_REVIEWER_ID }}
          private-key: ${{ secrets.APP_REVIEWER_SECRET }}

      - name: Extract Task ID from Branch
        id: extract-task
        run: |
          BRANCH="${{ github.event.pull_request.head.ref || github.ref_name }}"
          echo "Branch: $BRANCH"

          # Extract task ID from branch name patterns:
          # - test/task-99-timestamp
          # - refactor/task-99-timestamp
          # - 99-feature-name
          # - task-99
          TASK_ID=""
          if [[ "$BRANCH" =~ task-([0-9]+) ]]; then
            TASK_ID="${BASH_REMATCH[1]}"
          elif [[ "$BRANCH" =~ ^([0-9]+)[-_] ]]; then
            TASK_ID="${BASH_REMATCH[1]}"
          fi

          if [[ -n "$TASK_ID" ]]; then
            TASK_ID=$(printf "%02d" $((10#$TASK_ID)))
          fi

          echo "Extracted Task ID: $TASK_ID"
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT

      - name: Check Task ID
        if: steps.extract-task.outputs.task_id == ''
        run: |
          echo "::warning::Could not extract Task ID from branch name."
          echo "Branch should match pattern: task-XX or XX-feature-name"
          echo "Skipping reviewer."
          exit 0

      - name: Checkout Repo
        if: steps.extract-task.outputs.task_id != ''
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.mode == 'reviewer' && github.ref_name || github.event.pull_request.head.ref }}

      - name: Run AI Agent (Reviewer)
        if: steps.extract-task.outputs.task_id != ''
        uses: ./
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          mode: reviewer
          task_id: ${{ steps.extract-task.outputs.task_id }}
          pr_number: ${{ inputs.pr_number || github.event.pull_request.number }}
        env:
          GH_TOKEN: ${{ steps.app-reviewer-token.outputs.token }}
