name: AI Agent Test

on:
  workflow_dispatch:
    inputs:
      task_id:
        description: 'Task ID'
        default: '99'
      mode:
        description: 'Agent Mode'
        default: 'coder'
        type: choice
        options:
          - coder
          - reviewer
      pr_number:
        description: 'PR Number (for reviewer mode)'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  agent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build Agent
        run: go build -o agent ./cmd/agent

      - name: Run Agent
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          MODE: ${{ inputs.mode }}
          TASK_ID: ${{ inputs.task_id }}
          PR_NUMBER: ${{ inputs.pr_number }}
          MAX_RETRIES: '3'
        run: |
          echo "=== Running Agent ==="
          echo "Mode: $MODE"
          echo "Task ID: $TASK_ID"
          echo ""
          
          ./agent --mode "$MODE" --task "$TASK_ID" --provider gemini

      - name: Show Generated Files
        if: inputs.mode == 'coder'
        run: |
          echo "=== Git Status ==="
          git status
          
          echo ""
          echo "=== Changed Files Content ==="
          git diff --name-only | head -20 | while read file; do
            if [ -f "$file" ]; then
              echo "--- $file ---"
              head -50 "$file"
              echo ""
            fi
          done

      - name: Commit & Create PR
        if: inputs.mode == 'coder'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -z $(git status -s) ]]; then
            echo "No changes to commit"
            exit 0
          fi
          
          BRANCH_NAME="test/task-${{ inputs.task_id }}-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          git add .
          git commit -m "test: AI generated code (Task ${{ inputs.task_id }})"
          git push origin "$BRANCH_NAME"
          
          gh pr create \
            --title "Test: Task ${{ inputs.task_id }}" \
            --body "AI-generated implementation for testing.

          **Task ID:** ${{ inputs.task_id }}
          **Mode:** ${{ inputs.mode }}
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --base main \
            --head "$BRANCH_NAME"

      - name: Submit Review
        if: inputs.mode == 'reviewer' && inputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Review would be submitted to PR #${{ inputs.pr_number }}"
          echo "Check workflow logs for review content"
