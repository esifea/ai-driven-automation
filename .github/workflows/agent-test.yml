name: AI Agent Test

on:
  workflow_dispatch:
    inputs:
      task_id:
        description: 'Task ID'
        default: '99'
      mode:
        description: 'Agent Mode'
        default: 'coder'
        type: choice
        options:
          - coder
          - reviewer
      pr_number:
        description: 'PR Number (for reviewer mode)'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  agent:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR Branch (for reviewer mode)
        id: pr-branch
        if: inputs.mode == 'reviewer' && inputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BRANCH=$(gh pr view ${{ inputs.pr_number }} --repo ${{ github.repository }} --json headRefName -q '.headRefName')
          echo "branch=$PR_BRANCH" >> $GITHUB_OUTPUT
          echo "PR Branch: $PR_BRANCH"

      - name: Checkout Repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ steps.pr-branch.outputs.branch || github.ref }}

      - name: Show Current Branch
        run: |
          echo "Current branch: $(git branch --show-current)"
          echo "HEAD: $(git rev-parse HEAD)"

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'

      - name: Build Agent
        run: go build -o agent ./cmd/agent

      - name: Run Agent (Coder)
        if: inputs.mode == 'coder'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODE: ${{ inputs.mode }}
          TASK_ID: ${{ inputs.task_id }}
          MAX_RETRIES: '3'
        run: |
          echo "=== Running Agent (Coder) ==="
          echo "Task ID: $TASK_ID"
          ./agent --mode coder --task "$TASK_ID" --provider gemini

      - name: Run Agent (Reviewer)
        if: inputs.mode == 'reviewer'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TASK_ID: ${{ inputs.task_id }}
          PR_NUMBER: ${{ inputs.pr_number }}
          MAX_RETRIES: '3'
        run: |
          echo "=== Running Agent (Reviewer) ==="
          echo "Task ID: $TASK_ID"
          echo "PR Number: $PR_NUMBER"
          echo "=== Files in target directory ==="
          ls -la internal/test/ 2>/dev/null || echo "internal/test/ does not exist"
          echo ""
          ./agent --mode reviewer --task "$TASK_ID" --provider gemini 2>&1 | tee review_output.txt || true

      - name: Post Review Comment
        if: inputs.mode == 'reviewer' && inputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ inputs.pr_number }}
        run: |
          REVIEW_CONTENT=$(sed -n '/=== REVIEW CONTENT ===/,/=== END REVIEW ===/p' review_output.txt | grep -v '=== REVIEW CONTENT ===' | grep -v '=== END REVIEW ===')
          if [[ -n "$REVIEW_CONTENT" ]]; then
            echo "Posting review to PR #$PR_NUMBER"
            gh pr comment "$PR_NUMBER" --body "## AI Review"$'\n\n'"$REVIEW_CONTENT"
          else
            echo "No review content found"
          fi

      - name: Show Generated Files
        if: inputs.mode == 'coder'
        run: |
          echo "=== Git Status ==="
          git status
          echo ""
          echo "=== New & Modified Files Content ==="
          for file in $(git ls-files --others --exclude-standard | grep -v '^agent$' | head -20); do
            if [ -f "$file" ]; then
              echo ""
              echo "========== $file =========="
              head -100 "$file"
            fi
          done

      - name: Commit and Create PR
        if: inputs.mode == 'coder'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          rm -f agent
          if [[ -z $(git status -s) ]]; then
            echo "No changes to commit"
            exit 0
          fi
          BRANCH_NAME="test/task-${{ inputs.task_id }}-$(date +%s)"
          git checkout -b "$BRANCH_NAME"
          git add .
          git commit -m "test: AI generated code (Task ${{ inputs.task_id }})"
          git push origin "$BRANCH_NAME"
          gh pr create --title "Test: Task ${{ inputs.task_id }}" --body "AI-generated implementation for testing." --base main --head "$BRANCH_NAME"
